<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blog Editor</title>
</head>
<body>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script>
    // ───────────────────────────────────────
    // MARGIN NOTE — button in toolbar
    // ───────────────────────────────────────
    CMS.registerEditorComponent({
      id: "margin-note",
      label: "Side Note",
      fields: [
        {
          name: "note",
          label: "Note text",
          widget: "string"
        }
      ],
      pattern: /{{<\s*margin\s*>}}(.+?){{<\s*\/margin\s*>}}/,
      fromBlock: function(match) {
        return { note: match[1] };
      },
      toBlock: function(data) {
        return '{{< margin >}}' + data.note + '{{< /margin >}}';
      },
      toPreview: function(data) {
        return '<span style="float:right;width:30%;font-size:0.85em;font-style:italic;color:gray;margin-left:1em;">' + data.note + '</span>';
      }
    });

    // ───────────────────────────────────────
    // YOUTUBE VIDEO
    // ───────────────────────────────────────
    CMS.registerEditorComponent({
      id: "youtube",
      label: "YouTube Video",
      fields: [
        {
          name: "id",
          label: "YouTube Video ID or URL",
          widget: "string",
          hint: "e.g. dQw4w9WgXcQ or https://youtube.com/watch?v=dQw4w9WgXcQ"
        }
      ],
      pattern: /{{<\s*youtube\s+(\S+)\s*>}}/,
      fromBlock: function(match) {
        return { id: match[1] };
      },
      toBlock: function(data) {
        // Extract ID from full URL if pasted
        var id = data.id;
        var urlMatch = id.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]+)/);
        if (urlMatch) id = urlMatch[1];
        return '{{< youtube ' + id + ' >}}';
      },
      toPreview: function(data) {
        var id = data.id;
        var urlMatch = id.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]+)/);
        if (urlMatch) id = urlMatch[1];
        return '<div style="position:relative;padding-bottom:56.25%;height:0;"><iframe src="https://www.youtube.com/embed/' + id + '" style="position:absolute;top:0;left:0;width:100%;height:100%;" frameborder="0" allowfullscreen></iframe></div>';
      }
    });

    // ───────────────────────────────────────
    // VIMEO VIDEO
    // ───────────────────────────────────────
    CMS.registerEditorComponent({
      id: "vimeo",
      label: "Vimeo Video",
      fields: [
        {
          name: "id",
          label: "Vimeo Video ID or URL",
          widget: "string",
          hint: "e.g. 123456789 or https://vimeo.com/123456789"
        }
      ],
      pattern: /{{<\s*vimeo\s+(\S+)\s*>}}/,
      fromBlock: function(match) {
        return { id: match[1] };
      },
      toBlock: function(data) {
        var id = data.id;
        var urlMatch = id.match(/vimeo\.com\/(\d+)/);
        if (urlMatch) id = urlMatch[1];
        return '{{< vimeo ' + id + ' >}}';
      },
      toPreview: function(data) {
        var id = data.id;
        var urlMatch = id.match(/vimeo\.com\/(\d+)/);
        if (urlMatch) id = urlMatch[1];
        return '<div style="position:relative;padding-bottom:56.25%;height:0;"><iframe src="https://player.vimeo.com/video/' + id + '" style="position:absolute;top:0;left:0;width:100%;height:100%;" frameborder="0" allowfullscreen></iframe></div>';
      }
    });

    // ───────────────────────────────────────
    // TABLE (simple rows/columns)
    // ───────────────────────────────────────
    CMS.registerEditorComponent({
      id: "table",
      label: "Table",
      fields: [
        {
          name: "headers",
          label: "Column headers (comma-separated)",
          widget: "string",
          hint: "e.g. Project, Year, Category"
        },
        {
          name: "rows",
          label: "Rows (one per line, columns separated by commas)",
          widget: "text",
          hint: "e.g.\nSparsh, 2008, Multitouch\nLeChal, 2011, Haptic Wearable"
        }
      ],
      pattern: /\|(.+)\|\n\|[-| ]+\|\n((?:\|.+\|\n?)+)/,
      fromBlock: function(match) {
        var headers = match[1].split('|').map(function(s) { return s.trim(); }).filter(Boolean).join(', ');
        var rows = match[2].trim().split('\n').map(function(row) {
          return row.split('|').map(function(s) { return s.trim(); }).filter(Boolean).join(', ');
        }).join('\n');
        return { headers: headers, rows: rows };
      },
      toBlock: function(data) {
        var cols = data.headers.split(',').map(function(s) { return s.trim(); });
        var header = '| ' + cols.join(' | ') + ' |';
        var sep = '| ' + cols.map(function(c) { return '---'; }).join(' | ') + ' |';
        var rows = data.rows.trim().split('\n').map(function(row) {
          var cells = row.split(',').map(function(s) { return s.trim(); });
          return '| ' + cells.join(' | ') + ' |';
        }).join('\n');
        return header + '\n' + sep + '\n' + rows;
      },
      toPreview: function(data) {
        var cols = data.headers.split(',').map(function(s) { return s.trim(); });
        var html = '<table style="border-collapse:collapse;"><thead><tr>';
        cols.forEach(function(c) { html += '<th style="border:1px solid #111;padding:5px 12px;">' + c + '</th>'; });
        html += '</tr></thead><tbody>';
        data.rows.trim().split('\n').forEach(function(row) {
          html += '<tr>';
          row.split(',').forEach(function(cell) { html += '<td style="border:1px solid #111;padding:5px 12px;">' + cell.trim() + '</td>'; });
          html += '</tr>';
        });
        html += '</tbody></table>';
        return html;
      }
    });

    // ───────────────────────────────────────
    // MATH FORMULA (display block)
    // ───────────────────────────────────────
    CMS.registerEditorComponent({
      id: "math",
      label: "Math Formula",
      fields: [
        {
          name: "formula",
          label: "LaTeX formula",
          widget: "text",
          hint: "e.g. E = mc^2  or  \\frac{1}{f} = \\frac{1}{d_o} + \\frac{1}{d_i}"
        }
      ],
      pattern: /\$\$\n([\s\S]+?)\n\$\$/,
      fromBlock: function(match) {
        return { formula: match[1].trim() };
      },
      toBlock: function(data) {
        return '$$\n' + data.formula + '\n$$';
      },
      toPreview: function(data) {
        return '<pre style="text-align:center;font-family:serif;font-size:1.2em;padding:1em;background:#f9f9f0;">$$  ' + data.formula + '  $$</pre>';
      }
    });
  </script>
</body>
</html>
