<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blog Editor</title>
  <style>
    .login-gate {
      font-family: 'ET Book', Georgia, serif;
      max-width: 420px;
      margin: 15vh auto;
      padding: 2em;
      text-align: center;
    }
    .login-gate h1 {
      font-size: 1.6rem;
      font-weight: 400;
      margin-bottom: 0.5em;
    }
    .login-gate p {
      color: #555;
      font-size: 0.95rem;
      line-height: 1.5;
      margin-bottom: 1.5em;
    }
    .login-gate input[type="password"] {
      font: inherit;
      font-size: 1rem;
      width: 100%;
      padding: 10px 14px;
      border: 1.5px solid #111;
      background: #FFFFF8;
      box-sizing: border-box;
      margin-bottom: 1em;
    }
    .login-gate button {
      font: inherit;
      font-size: 1rem;
      padding: 10px 28px;
      border: 1.5px solid #111;
      background: #111;
      color: #FFFFF8;
      cursor: pointer;
    }
    .login-gate button:hover { background: #333; }
    .login-gate a {
      display: block;
      margin-top: 1.2em;
      font-size: 0.85rem;
      color: #555;
    }
    .login-gate .error {
      color: #c00;
      font-size: 0.9rem;
      margin-bottom: 1em;
    }
  </style>
</head>
<body>
  <script>
    // ─── PAT Login Gate ─────────────────────
    var stored = localStorage.getItem('cms-github-token');

    if (!stored) {
      // Show login form
      document.body.innerHTML = '\
        <div class="login-gate">\
          <h1>Blog Editor</h1>\
          <p>Paste your GitHub Personal Access Token to sign in.<br>\
          Generate one at <a href="https://github.com/settings/tokens?type=beta" target="_blank">github.com/settings/tokens</a><br>\
          Select repo <strong>anirudh.me</strong>, set <strong>Contents: Read and write</strong>.</p>\
          <div id="error" class="error" style="display:none"></div>\
          <form id="login-form">\
            <input type="password" id="pat" placeholder="github_pat_xxxxxxxxxxxx" autocomplete="off" />\
            <button type="submit">Sign In</button>\
          </form>\
          <a href="../">&larr; Back to blog</a>\
        </div>';

      document.getElementById('login-form').addEventListener('submit', function(e) {
        e.preventDefault();
        var token = document.getElementById('pat').value.trim();
        if (!token) return;

        var errEl = document.getElementById('error');
        errEl.style.display = 'none';

        fetch('https://api.github.com/user', {
          headers: { 'Authorization': 'token ' + token }
        }).then(function(r) {
          if (!r.ok) throw new Error('Invalid token');
          return r.json();
        }).then(function(user) {
          localStorage.setItem('cms-github-token', token);
          // Pre-inject auth for Decap CMS
          localStorage.setItem('decap-cms-user', JSON.stringify({
            token: token,
            backendName: 'github'
          }));
          location.reload();
        }).catch(function(err) {
          errEl.textContent = 'Invalid token. Make sure it has Contents read/write permission.';
          errEl.style.display = 'block';
        });
      });
    } else {
      // We have a token — inject auth before CMS loads
      localStorage.setItem('decap-cms-user', JSON.stringify({
        token: stored,
        backendName: 'github'
      }));

      // Load Decap CMS
      var script = document.createElement('script');
      script.src = 'https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js';
      script.onload = function() {

        // ─── MARGIN NOTE ───
        CMS.registerEditorComponent({
          id: "margin-note",
          label: "Side Note",
          fields: [
            { name: "note", label: "Note text", widget: "string" }
          ],
          pattern: /{{<\s*margin\s*>}}(.+?){{<\s*\/margin\s*>}}/,
          fromBlock: function(match) { return { note: match[1] }; },
          toBlock: function(data) { return '{{< margin >}}' + data.note + '{{< /margin >}}'; },
          toPreview: function(data) { return '<span style="float:right;width:30%;font-size:0.85em;font-style:italic;color:gray;margin-left:1em;">' + data.note + '</span>'; }
        });

        // ─── YOUTUBE ───
        CMS.registerEditorComponent({
          id: "youtube",
          label: "YouTube Video",
          fields: [
            { name: "id", label: "YouTube Video ID or URL", widget: "string", hint: "e.g. dQw4w9WgXcQ or https://youtube.com/watch?v=dQw4w9WgXcQ" }
          ],
          pattern: /{{<\s*youtube\s+(\S+)\s*>}}/,
          fromBlock: function(match) { return { id: match[1] }; },
          toBlock: function(data) {
            var id = data.id;
            var m = id.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]+)/);
            if (m) id = m[1];
            return '{{< youtube ' + id + ' >}}';
          },
          toPreview: function(data) {
            var id = data.id;
            var m = id.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]+)/);
            if (m) id = m[1];
            return '<div style="position:relative;padding-bottom:56.25%;height:0;"><iframe src="https://www.youtube.com/embed/' + id + '" style="position:absolute;top:0;left:0;width:100%;height:100%;" frameborder="0" allowfullscreen></iframe></div>';
          }
        });

        // ─── VIMEO ───
        CMS.registerEditorComponent({
          id: "vimeo",
          label: "Vimeo Video",
          fields: [
            { name: "id", label: "Vimeo Video ID or URL", widget: "string", hint: "e.g. 123456789 or https://vimeo.com/123456789" }
          ],
          pattern: /{{<\s*vimeo\s+(\S+)\s*>}}/,
          fromBlock: function(match) { return { id: match[1] }; },
          toBlock: function(data) {
            var id = data.id;
            var m = id.match(/vimeo\.com\/(\d+)/);
            if (m) id = m[1];
            return '{{< vimeo ' + id + ' >}}';
          },
          toPreview: function(data) {
            var id = data.id;
            var m = id.match(/vimeo\.com\/(\d+)/);
            if (m) id = m[1];
            return '<div style="position:relative;padding-bottom:56.25%;height:0;"><iframe src="https://player.vimeo.com/video/' + id + '" style="position:absolute;top:0;left:0;width:100%;height:100%;" frameborder="0" allowfullscreen></iframe></div>';
          }
        });

        // ─── TABLE ───
        CMS.registerEditorComponent({
          id: "table",
          label: "Table",
          fields: [
            { name: "headers", label: "Column headers (comma-separated)", widget: "string", hint: "e.g. Project, Year, Category" },
            { name: "rows", label: "Rows (one per line, columns separated by commas)", widget: "text", hint: "e.g.\nSparsh, 2008, Multitouch\nLeChal, 2011, Haptic Wearable" }
          ],
          pattern: /\|(.+)\|\n\|[-| ]+\|\n((?:\|.+\|\n?)+)/,
          fromBlock: function(match) {
            var headers = match[1].split('|').map(function(s) { return s.trim(); }).filter(Boolean).join(', ');
            var rows = match[2].trim().split('\n').map(function(row) {
              return row.split('|').map(function(s) { return s.trim(); }).filter(Boolean).join(', ');
            }).join('\n');
            return { headers: headers, rows: rows };
          },
          toBlock: function(data) {
            var cols = data.headers.split(',').map(function(s) { return s.trim(); });
            var header = '| ' + cols.join(' | ') + ' |';
            var sep = '| ' + cols.map(function() { return '---'; }).join(' | ') + ' |';
            var rows = data.rows.trim().split('\n').map(function(row) {
              return '| ' + row.split(',').map(function(s) { return s.trim(); }).join(' | ') + ' |';
            }).join('\n');
            return header + '\n' + sep + '\n' + rows;
          },
          toPreview: function(data) {
            var cols = data.headers.split(',').map(function(s) { return s.trim(); });
            var html = '<table style="border-collapse:collapse;"><thead><tr>';
            cols.forEach(function(c) { html += '<th style="border:1px solid #111;padding:5px 12px;">' + c + '</th>'; });
            html += '</tr></thead><tbody>';
            data.rows.trim().split('\n').forEach(function(row) {
              html += '<tr>';
              row.split(',').forEach(function(cell) { html += '<td style="border:1px solid #111;padding:5px 12px;">' + cell.trim() + '</td>'; });
              html += '</tr>';
            });
            html += '</tbody></table>';
            return html;
          }
        });

        // ─── MATH FORMULA ───
        CMS.registerEditorComponent({
          id: "math",
          label: "Math Formula",
          fields: [
            { name: "formula", label: "LaTeX formula", widget: "text", hint: "e.g. E = mc^2" }
          ],
          pattern: /\$\$\n([\s\S]+?)\n\$\$/,
          fromBlock: function(match) { return { formula: match[1].trim() }; },
          toBlock: function(data) { return '$$\n' + data.formula + '\n$$'; },
          toPreview: function(data) { return '<pre style="text-align:center;font-family:serif;font-size:1.2em;padding:1em;background:#f9f9f0;">$$  ' + data.formula + '  $$</pre>'; }
        });
      };
      document.head.appendChild(script);
    }
  </script>
</body>
</html>
